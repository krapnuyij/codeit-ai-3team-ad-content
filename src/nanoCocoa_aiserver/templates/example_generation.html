<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Ad Example Generation (L4 Optimized)</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>

<body>

    <header style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>AI ê´‘ê³  ì˜ˆì‹œ ìƒì„± (Example Generation)</h1>
            <span style="font-size: 12px; color: var(--text-muted);">L4 ìµœì í™” ë‹¨ê³„ë³„ ìƒì„± (Step-by-Step Generation)</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="cancelJob()" class="btn-secondary" id="btn_cancel"
                style="display: none; background: #d32f2f;">ì‘ì—… ì·¨ì†Œ</button>
            <button onclick="resetAll()" class="btn-secondary">í™”ë©´ ì´ˆê¸°í™”</button>
            <label
                style="display: flex; align-items: center; gap: 6px; font-size: 13px; background: var(--panel-bg); padding: 4px 12px; border-radius: 20px; border: 1px solid var(--border-color);">
                <input type="checkbox" id="test_mode" checked> ë”ë¯¸ ëª¨ë“œ (GPU ë¯¸ì‚¬ìš©)
            </label>
        </div>
    </header>

    <div class="layout">
        <!-- Sidebar Controls -->
        <div class="sidebar">
            <!-- Execution Control -->
            <div class="panel">
                <div class="panel-header">ì‹¤í–‰ ë²”ìœ„ ì„¤ì •</div>
                <div class="control-group">
                    <label>ì‹œì‘ ë‹¨ê³„ (Start Step)</label>
                    <div style="display: flex; gap: 12px;">
                        <label><input type="radio" name="start_step" value="1" checked onchange="updateUI()"> 1ë‹¨ê³„
                            (ì „ì²´)</label>
                        <label><input type="radio" name="start_step" value="2" onchange="updateUI()"> 2ë‹¨ê³„ (í…ìŠ¤íŠ¸)</label>
                        <label><input type="radio" name="start_step" value="3" onchange="updateUI()"> 3ë‹¨ê³„ (í•©ì„±)</label>
                    </div>
                </div>
                <div class="control-group">
                    <label>ì¢…ë£Œ ë‹¨ê³„ (Stop Step)</label>
                    <select id="stop_step" onchange="saveToLocalStorage()">
                        <option value="" selected>ì „ì²´ ì‹¤í–‰ (ì™„ë£Œê¹Œì§€)</option>
                        <option value="1">1ë‹¨ê³„ê¹Œì§€ë§Œ (ë°°ê²½ ìƒì„±)</option>
                        <option value="2">2ë‹¨ê³„ê¹Œì§€ë§Œ (ë°°ê²½ + í…ìŠ¤íŠ¸)</option>
                        <option value="3">3ë‹¨ê³„ê¹Œì§€ (ì „ì²´ ì™„ì„±)</option>
                    </select>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        íŠ¹ì • ë‹¨ê³„ê¹Œì§€ë§Œ ì‹¤í–‰í•˜ê³  ì¤‘ë‹¨ (ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ì‹¤í–‰)
                    </div>
                </div>
            </div>

            <!-- Step 1 Params -->
            <div class="panel" id="panel_step1">
                <div class="panel-header">1ë‹¨ê³„: ë°°ê²½ ìƒì„±</div>

                <div class="control-group">
                    <label>ì…ë ¥ ì´ë¯¸ì§€ (ìƒí’ˆ)</label>
                    <input type="file" id="input_image_file" accept="image/*"
                        onchange="encodeImage(this, 'input_image_b64')">
                    <input type="hidden" id="input_image_b64">
                    <div id="input_preview"
                        style="height: 60px; background: #222; margin-top: 5px; border-radius: 4px; display: none; align-items: center; justify-content: center;">
                        <img src="" style="height: 100%; object-fit: contain;">
                    </div>
                </div>

                <div class="control-group">
                    <label>ë°°ê²½ ìƒì„± ëª¨ë¸ (Background Model)</label>
                    <select id="bg_model" onchange="adjustGuidanceForModel()">
                        <option value="flux" selected>Flux (ê³ í’ˆì§ˆ, ë¹ ë¥¸ ìƒì„±, guidance 3.5 ê¶Œì¥)</option>
                        <option value="sdxl">SDXL (ì‹¬í”Œ, guidance 7.5 ê¶Œì¥)</option>
                    </select>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        ë°°ê²½ ì´ë¯¸ì§€ ìƒì„±ì— ì‚¬ìš©í•  AI ëª¨ë¸
                    </div>
                </div>

                <div class="control-group">
                    <label>ë°°ê²½ í”„ë¡¬í”„íŠ¸ (ì˜ë¬¸)</label>
                    <textarea
                        id="bg_prompt">A photorealistic close-up shot of a ripe yellow banana lying naturally on a rustic wooden table., Heavy contact shadows, ambient occlusion, wood texture reflection, warm sunlight, cinematic lighting, 8k, extremely detailed.</textarea>
                </div>

                <div class="control-group">
                    <label>ë°°ê²½ ë¶€ì • í”„ë¡¬í”„íŠ¸ (ì˜ë¬¸)</label>
                    <input type="text" id="bg_negative_prompt"
                        value="blurry, low quality, distorted, ugly, bad lighting, overexposed, underexposed, artificial, plastic">
                </div>

                <div class="control-group">
                    <label>ë°°ê²½ í•©ì„± í”„ë¡¬í”„íŠ¸ (Background Composition, ì˜ë¬¸)</label>
                    <textarea id="bg_composition_prompt"
                        rows="3">A photorealistic object lying naturally on a rustic wooden table. Heavy contact shadows, ambient occlusion, wood texture reflection, warm sunlight, cinematic lighting, 8k, extremely detailed.</textarea>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        ë°°ê²½ê³¼ ìƒí’ˆì„ ìì—°ìŠ¤ëŸ½ê²Œ í•©ì„±í•˜ê¸° ìœ„í•œ í”„ë¡¬í”„íŠ¸
                    </div>
                </div>

                <div class="control-group">
                    <label>ë°°ê²½ í•©ì„± ë¶€ì • í”„ë¡¬í”„íŠ¸ (ì˜ë¬¸)</label>
                    <input type="text" id="bg_composition_negative_prompt"
                        value="floating, disconnected, unrealistic shadows, artificial lighting, cut out, sticker effect">
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        ë°°ê²½ í•©ì„±ì—ì„œ ì œì™¸í•  ìš”ì†Œ
                    </div>
                </div>

                <div class="control-group">
                    <label>ë°°ê²½ í•©ì„± ê°•ë„ (Composition Strength, 0.0 - 1.0)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="range" id="strength" min="0" max="1" step="0.01" value="0.6" style="flex: 1;">
                        <span id="strength_val" style="width: 30px; text-align: right; font-size: 12px;">0.6</span>
                    </div>
                </div>
            </div>

            <!-- Step 2 Params -->
            <div class="panel" id="panel_step2">
                <div class="panel-header">2ë‹¨ê³„: 3D í…ìŠ¤íŠ¸</div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ ë‚´ìš©</label>
                    <input type="text" id="text_content" value="ë§›ìˆëŠ” ë°”ë‚˜ë‚˜">
                </div>

                <div class="control-group">
                    <label>í°íŠ¸ ì„ íƒ</label>
                    <select id="font_name"></select>
                    <div id="font_preview"
                        style="font-size: 24px; color: #fff; margin-top: 8px; text-align: center; height: 40px; line-height: 40px; background: #222; border-radius: 4px;">
                        ABC ê°€ë‚˜ë‹¤</div>
                </div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ ì¬ì§ˆ í”„ë¡¬í”„íŠ¸ (ì˜ë¬¸)</label>
                    <textarea
                        id="text_prompt">3D render of gold foil balloon text, inflated letters, shiny metallic reflective texture, smooth surface, floating in air, studio lighting, sharp details, high quality, isolated on black background</textarea>
                </div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ ëª¨ë¸ ë¶€ì • í”„ë¡¬í”„íŠ¸ (ì˜ë¬¸)</label>
                    <input type="text" id="text_negative_prompt"
                        value="low quality, ugly, distorted, flat, 2d, blurry, pixelated, deformed text, unreadable">
                </div>
            </div>

            <!-- Step 3 Params (í…ìŠ¤íŠ¸ í•©ì„± íŒŒë¼ë¯¸í„°) -->
            <div class="panel" id="panel_step3">
                <div class="panel-header">3ë‹¨ê³„: í…ìŠ¤íŠ¸ í•©ì„± (Text Composition)</div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ í•©ì„± ëª¨ë“œ (Text Composition Mode)</label>
                    <select id="composition_mode">
                        <option value="overlay" selected>ìœ„ì— ë®ê¸° (Overlay) - ëª…í™•í•œ í…ìŠ¤íŠ¸</option>
                        <option value="blend">ìì—°ìŠ¤ëŸ½ê²Œ ì„ê¸° (Blend) - ì¡°í™”ë¡œìš´ í†µí•©</option>
                        <option value="behind">ë’¤ì— ë°°ì¹˜ (Behind) - ê¹Šì´ê° ì—°ì¶œ</option>
                    </select>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        í…ìŠ¤íŠ¸ì™€ ë°°ê²½ì˜ í•©ì„± ë°©ì‹
                    </div>
                </div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ ìœ„ì¹˜ (Text Position)</label>
                    <select id="text_position">
                        <option value="top" selected>ìƒë‹¨ (Top)</option>
                        <option value="center">ì¤‘ì•™ (Center)</option>
                        <option value="bottom">í•˜ë‹¨ (Bottom)</option>
                        <option value="auto">ìë™ (Auto) - ìµœì  ìœ„ì¹˜</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ í•©ì„± í”„ë¡¬í”„íŠ¸ (Text Composition Prompt, ì„ íƒ, ì˜ë¬¸)</label>
                    <textarea id="composition_prompt"
                        placeholder="ì˜ˆ: with subtle shadow, glowing effect, integrated with lighting"
                        rows="2"></textarea>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        í•©ì„± ì‹œ ì¶”ê°€ íš¨ê³¼ ì§€ì • (ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±)
                    </div>
                </div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ í•©ì„± ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ (ì„ íƒ, ì˜ë¬¸)</label>
                    <input type="text" id="composition_negative_prompt"
                        placeholder="ì˜ˆ: floating, disconnected, unrealistic shadows">
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        í•©ì„±ì—ì„œ ì œì™¸í•  ìš”ì†Œ (ë¹„ì›Œë‘ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                    </div>
                </div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ í•©ì„± ê°•ë„ (Text Composition Strength)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="range" id="composition_strength" min="0" max="1" step="0.05" value="0.4"
                            style="flex: 1;">
                        <span id="composition_strength_val"
                            style="width: 35px; text-align: right; font-size: 12px;">0.4</span>
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        ë‚®ì„ìˆ˜ë¡ ì›ë³¸ ë³´ì¡´, ë†’ì„ìˆ˜ë¡ í”„ë¡¬í”„íŠ¸ ë°˜ì˜
                    </div>
                </div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ í•©ì„± ì¸í¼ëŸ°ìŠ¤ ìŠ¤í… (Inference Steps)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="range" id="composition_steps" min="10" max="50" step="1" value="28"
                            style="flex: 1;">
                        <span id="composition_steps_val"
                            style="width: 35px; text-align: right; font-size: 12px;">28</span>
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        ë†’ì„ìˆ˜ë¡ í’ˆì§ˆâ†‘ ì‹œê°„â†‘ (28~35 ê¶Œì¥)
                    </div>
                </div>

                <div class="control-group">
                    <label>í…ìŠ¤íŠ¸ í•©ì„± ê°€ì´ë˜ìŠ¤ ìŠ¤ì¼€ì¼</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="range" id="composition_guidance_scale" min="1" max="7" step="0.1" value="3.5"
                            style="flex: 1;">
                        <span id="composition_guidance_val"
                            style="width: 35px; text-align: right; font-size: 12px;">3.5</span>
                    </div>
                </div>
            </div>

            <!-- Common Params -->
            <div class="panel">
                <div class="panel-header">ê³µí†µ íŒŒë¼ë¯¸í„°</div>
                <div class="control-group">
                    <label>ê°€ì´ë˜ìŠ¤ ìŠ¤ì¼€ì¼ (Guidance Scale)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="range" id="guidance_scale" min="1" max="10" step="0.1" value="3.5" style="flex: 1;">
                        <span id="guidance_val" style="width: 30px; text-align: right; font-size: 12px;">3.5</span>
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        Flux: 3.5 ê¶Œì¥, SDXL: 7.5 ê¶Œì¥
                    </div>
                </div>
                <div class="control-group">
                    <label>ì‹œë“œ (Seed, ì„ íƒ)</label>
                    <input type="number" id="seed" placeholder="Random (ëœë¤)">
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        ë™ì¼í•œ ì‹œë“œ ê°’ê³¼ íŒŒë¼ë¯¸í„°ëŠ” ë™ì¼í•œ ê²°ê³¼ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ (ì¬í˜„ì„± ë³´ì¥)
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="startGeneration()">ê´‘ê³  ìƒì„± ì‹œì‘</button>
            <div id="error_msg" style="color: var(--error-color); font-size: 12px; margin-top: 10px; min-height: 16px;">
            </div>
        </div>

        <!-- Main Display -->
        <div style="display: flex; flex-direction: column; gap: 16px; min-height: 0;">
            <!-- Status Bar -->
            <div class="status-bar">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="status_icon">â—</span>
                    <span id="status_text" style="color: #fff; font-weight: 500;">ì¤€ë¹„ë¨ (Ready)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="step_info" style="color: var(--text-muted);">ë‹¨ê³„: -</span>
                    <span id="eta_info" style="color: var(--accent-color); font-size: 12px;">ì˜ˆìƒ ì‹œê°„: -</span>
                    <span id="progress_info" style="color: var(--primary-color); font-weight: bold;">0%</span>
                </div>
            </div>

            <!-- Progress Bar -->
            <div
                style="background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="font-size: 12px; color: var(--text-muted);" id="sub_step_info">-</span>
                    <span style="font-size: 12px; color: var(--primary-color);" id="progress_text">0%</span>
                </div>
                <div style="width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden;">
                    <div id="progress_bar"
                        style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); transition: width 0.3s ease;">
                    </div>
                </div>
            </div>

            <!-- System Metrics -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; display: none;"
                id="metrics_panel">
                <div style="font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--text-muted);">ì‹œìŠ¤í…œ ì‚¬ìš©ë¥ 
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 3px;">CPU</div>
                        <div style="font-size: 10px;" id="cpu_usage">-</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 3px;">RAM</div>
                        <div style="font-size: 10px;" id="ram_usage">-</div>
                    </div>
                    <div id="gpu_metrics_container">
                        <!-- GPU metrics will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Results Grid -->
            <div class="results">
                <!-- Step 1 Result -->
                <div class="result-card">
                    <div class="panel-header">1ë‹¨ê³„: ë°°ê²½ ê²°ê³¼</div>
                    <div class="image-container" id="container_step1">
                        <span class="placeholder">ëŒ€ê¸° ì¤‘...</span>
                    </div>
                </div>

                <!-- Step 2 Result -->
                <div class="result-card">
                    <div class="panel-header">2ë‹¨ê³„: í…ìŠ¤íŠ¸ ì—ì…‹</div>
                    <div class="image-container" id="container_step2">
                        <span class="placeholder">ëŒ€ê¸° ì¤‘...</span>
                    </div>
                </div>

                <!-- Final Result -->
                <div class="result-card" style="border-color: var(--primary-color);">
                    <div class="panel-header" style="color: #fff;">ğŸ† ìµœì¢… ê²°ê³¼</div>
                    <div class="image-container" id="container_final">
                        <span class="placeholder">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</span>
                    </div>
                </div>

                <!-- CLIP Score Evaluation -->
                <div class="result-card" style="border-color: var(--accent-color);">
                    <div class="panel-header" style="color: #fff;">ğŸ“Š CLIP Score í‰ê°€</div>
                    <div style="padding: 16px;">
                        <div class="control-group">
                            <label>í‰ê°€í•  ì´ë¯¸ì§€ ì„ íƒ</label>
                            <select id="clip_image_select" onchange="updateClipImagePreview()">
                                <option value="">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="step1">1ë‹¨ê³„ ê²°ê³¼ (ë°°ê²½)</option>
                                <option value="step2">2ë‹¨ê³„ ê²°ê³¼ (í…ìŠ¤íŠ¸)</option>
                                <option value="final">ìµœì¢… ê²°ê³¼</option>
                                <option value="upload">ì§ì ‘ ì—…ë¡œë“œ...</option>
                            </select>
                        </div>

                        <div class="control-group" id="clip_upload_section" style="display: none;">
                            <label>ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
                            <input type="file" id="clip_image_file" accept="image/*"
                                onchange="encodeImage(this, 'clip_image_b64')">
                            <input type="hidden" id="clip_image_b64">
                        </div>

                        <div class="control-group">
                            <label>í”„ë¡¬í”„íŠ¸ (í•œê¸€/ì˜ë¬¸)</label>
                            <textarea id="clip_prompt" rows="3" 
                                placeholder="ì˜ˆ: ì‚¬ê³¼ê°€ ê·¸ë ¤ì ¸ ìˆê³  ê°€ê²©ê³¼ íŒë§¤ ì¥ì†Œê°€ ì í˜€ ìˆëŠ” ê´‘ê³  í¬ìŠ¤í„°"></textarea>
                            <button class="btn-secondary" onclick="useGenerationPrompt()" 
                                style="margin-top: 8px; font-size: 12px;">
                                ğŸ”„ ìƒì„± í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
                            </button>
                        </div>

                        <div class="control-group">
                            <label>ëª¨ë¸ ì„ íƒ</label>
                            <select id="clip_model_type">
                                <option value="koclip" selected>KoCLIP (í•œê¸€ í”„ë¡¬í”„íŠ¸)</option>
                                <option value="openai">OpenAI CLIP (ì˜ë¬¸ í”„ë¡¬í”„íŠ¸)</option>
                            </select>
                        </div>

                        <button class="btn-primary" onclick="calculateClipScore()" style="width: 100%;">
                            CLIP Score ê³„ì‚°
                        </button>

                        <div id="clip_result" style="margin-top: 16px; display: none;">
                            <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); 
                                border-radius: 8px; padding: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="font-size: 13px; color: var(--text-muted);">CLIP Score</span>
                                    <span id="clip_score" style="font-size: 24px; font-weight: bold; color: var(--accent-color);">
                                        -
                                    </span>
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                                    ì‚¬ìš© ëª¨ë¸: <span id="clip_used_model">-</span>
                                </div>
                                <div id="clip_interpretation" 
                                    style="font-size: 13px; color: #fff; line-height: 1.5;">
                                    -
                                </div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">ì ìˆ˜ ê°€ì´ë“œ</div>
                                    <div style="font-size: 11px; color: var(--text-muted); line-height: 1.6;">
                                        â€¢ 0.7 ì´ìƒ: ë§¤ìš° ë†’ì€ ì¼ì¹˜ë„<br>
                                        â€¢ 0.5~0.7: ë†’ì€ ì¼ì¹˜ë„<br>
                                        â€¢ 0.3~0.5: ì¤‘ê°„ ì¼ì¹˜ë„<br>
                                        â€¢ 0.3 ë¯¸ë§Œ: ë‚®ì€ ì¼ì¹˜ë„
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="clip_error" style="color: var(--error-color); font-size: 12px; margin-top: 10px; display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load JS modules in order -->
    <script src="/static/js/storage.js"></script>
    <script src="/static/js/ui.js"></script>
    <script src="/static/js/timing.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/main.js"></script>

    <!-- CLIP Score Functions -->
    <script>
        // CLIP Score ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
        let generatedImages = {
            step1: null,
            step2: null,
            final: null
        };

        // ì´ë¯¸ì§€ ì„ íƒ ì‹œ ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
        function updateClipImagePreview() {
            const select = document.getElementById('clip_image_select');
            const uploadSection = document.getElementById('clip_upload_section');
            
            if (select.value === 'upload') {
                uploadSection.style.display = 'block';
            } else {
                uploadSection.style.display = 'none';
            }
        }

        // ìƒì„± í”„ë¡¬í”„íŠ¸ë¥¼ CLIP í”„ë¡¬í”„íŠ¸ë¡œ ë³µì‚¬
        function useGenerationPrompt() {
            const bgPrompt = document.getElementById('bg_prompt').value;
            const textContent = document.getElementById('text_content').value;
            
            let prompt = '';
            if (textContent) {
                prompt = `${textContent} í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ê´‘ê³ . ${bgPrompt}`;
            } else {
                prompt = bgPrompt;
            }
            
            document.getElementById('clip_prompt').value = prompt;
        }

        // ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ ì €ì¥ (ê¸°ì¡´ displayResult í•¨ìˆ˜ ìˆ˜ì • í•„ìš”)
        function saveGeneratedImage(step, base64Image) {
            generatedImages[step] = base64Image;
        }

        // CLIP Score ê³„ì‚°
        async function calculateClipScore() {
            const imageSelect = document.getElementById('clip_image_select').value;
            const prompt = document.getElementById('clip_prompt').value;
            const modelType = document.getElementById('clip_model_type').value;
            const clipError = document.getElementById('clip_error');
            const clipResult = document.getElementById('clip_result');

            // ì…ë ¥ ê²€ì¦
            if (!imageSelect) {
                clipError.textContent = 'ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                clipError.style.display = 'block';
                clipResult.style.display = 'none';
                return;
            }

            if (!prompt.trim()) {
                clipError.textContent = 'í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                clipError.style.display = 'block';
                clipResult.style.display = 'none';
                return;
            }

            // ì´ë¯¸ì§€ Base64 ê°€ì ¸ì˜¤ê¸°
            let imageBase64;
            if (imageSelect === 'upload') {
                imageBase64 = document.getElementById('clip_image_b64').value;
                if (!imageBase64) {
                    clipError.textContent = 'ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
                    clipError.style.display = 'block';
                    clipResult.style.display = 'none';
                    return;
                }
            } else {
                imageBase64 = generatedImages[imageSelect];
                if (!imageBase64) {
                    clipError.textContent = 'ì„ íƒí•œ ë‹¨ê³„ì˜ ì´ë¯¸ì§€ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                    clipError.style.display = 'block';
                    clipResult.style.display = 'none';
                    return;
                }
            }

            // data:image/png;base64, ì ‘ë‘ì‚¬ ì œê±°
            if (imageBase64.includes(',')) {
                imageBase64 = imageBase64.split(',')[1];
            }

            // ë¡œë”© í‘œì‹œ
            clipError.style.display = 'none';
            clipResult.style.display = 'block';
            document.getElementById('clip_score').textContent = 'ê³„ì‚° ì¤‘...';
            document.getElementById('clip_interpretation').textContent = 'CLIP Scoreë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì²« ìš”ì²­ ì‹œ ëª¨ë¸ ë¡œë”©ìœ¼ë¡œ 5~10ì´ˆ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';

            try {
                const response = await fetch('/clip-score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_base64: imageBase64,
                        prompt: prompt,
                        model_type: modelType
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'CLIP Score ê³„ì‚° ì‹¤íŒ¨');
                }

                const result = await response.json();

                // ê²°ê³¼ í‘œì‹œ
                document.getElementById('clip_score').textContent = result.clip_score.toFixed(4);
                document.getElementById('clip_used_model').textContent = result.model_type === 'koclip' ? 'KoCLIP (í•œê¸€)' : 'OpenAI CLIP (ì˜ë¬¸)';
                document.getElementById('clip_interpretation').textContent = result.interpretation;

                // ì ìˆ˜ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                const scoreElement = document.getElementById('clip_score');
                const score = result.clip_score;
                if (score >= 0.7) {
                    scoreElement.style.color = '#4CAF50'; // ë…¹ìƒ‰
                } else if (score >= 0.5) {
                    scoreElement.style.color = '#8BC34A'; // ì—°ë‘ìƒ‰
                } else if (score >= 0.3) {
                    scoreElement.style.color = '#FFC107'; // ë…¸ë€ìƒ‰
                } else {
                    scoreElement.style.color = '#FF5722'; // ë¹¨ê°„ìƒ‰
                }

            } catch (error) {
                console.error('CLIP Score calculation error:', error);
                clipError.textContent = `ì˜¤ë¥˜: ${error.message}`;
                clipError.style.display = 'block';
                clipResult.style.display = 'none';
            }
        }

        // ê¸°ì¡´ displayResult í•¨ìˆ˜ë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥ ì¶”ê°€
        const originalDisplayResult = window.displayResult;
        if (typeof originalDisplayResult === 'function') {
            window.displayResult = function(data) {
                // ì›ë³¸ í•¨ìˆ˜ ì‹¤í–‰
                originalDisplayResult(data);
                
                // ì´ë¯¸ì§€ ì €ì¥
                if (data.step1_result) {
                    saveGeneratedImage('step1', data.step1_result);
                }
                if (data.step2_result) {
                    saveGeneratedImage('step2', data.step2_result);
                }
                if (data.final_result) {
                    saveGeneratedImage('final', data.final_result);
                }
            };
        }
    </script>
</body>

</html>